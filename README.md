# y-furniture 插件说明

本项目为 AutoCAD 2018 的 .dll 插件，主要用于自动化建模家具部件。

## 目录

- [y-furniture 插件说明](#y-furniture-插件说明)
  - [目录](#目录)
  - [项目结构](#项目结构)
  - [环境与依赖](#环境与依赖)
  - [编译与加载](#编译与加载)
  - [1. 三轴加工功能](#1-三轴加工功能)
    - [主要逻辑](#主要逻辑)
    - [相关代码](#相关代码)
    - [功能案例](#功能案例)
      - [306型餐桌绘制要点](#306型餐桌绘制要点)
      - [309型餐桌绘制要点](#309型餐桌绘制要点)
      - [串带门板绘制要点](#串带门板绘制要点)
    - [注意事项](#注意事项)
  - [2. 部件制作功能](#2-部件制作功能)
    - [主要逻辑](#主要逻辑-1)
    - [相关代码](#相关代码-1)
    - [功能案例](#功能案例-1)
      - [抽屉框制作要点](#抽屉框制作要点)
    - [注意事项](#注意事项-1)
  - [3. 家具属性功能](#3-家具属性功能)
    - [主要逻辑](#主要逻辑-2)
    - [相关代码](#相关代码-2)
    - [功能案例](#功能案例-2)
      - [属性编辑与查看](#属性编辑与查看)
    - [注意事项](#注意事项-2)

---

## 项目结构

```
y-furniture/
│
├── furniture.sln           # Visual Studio 解决方案文件
├── README.md               # 项目说明文档
│
└───furniture/              # 主项目目录
    │
    ├── furniture.csproj        # C# 项目文件 (包含依赖项)
    │
    ├── Core/                   # 核心逻辑 (插件入口、Ribbon)
    │   ├── Plugin.cs
    │   └── RibbonController.cs
    │
    ├── Commands/               # 命令处理器
    │   ├── ComponentsPaletteCommandHandler.cs
    │   ├── DrawingsPaletteCommandHandler.cs
    │   ├── DrawRectangleCommandHandler.cs
    │   └── DrawBoxCommandHandler.cs
    │
    ├── Features/               # 核心功能 (绘图、建模)
    │   ├── DrawerBox.cs
    │   └── DrawingUtils.cs
    │
    └───UI/                     # 用户界面
        │
        ├── Forms/              # 参数输入对话框
        │   ├── DoorInputForm.cs
        │   └── Table309InputForm.cs
        │
        └───Palettes/           # Palette 控件
            ├── ComponentsPaletteControl.cs
            └── DrawingsPaletteControl.cs
```

## 环境与依赖

- **AutoCAD**: 2018
- **.NET Framework**: net47
- **主要依赖**:
  - `AutoCAD.NET` (accoremgd.dll, acdbmgd.dll, acmgd.dll)

---

## 编译与加载

- 编译命令：
  ```
  dotnet restore
  dotnet build
  ```
- DLL 路径：`furniture\bin\Debug\net47\furniture.dll`
- AutoCAD 加载方式（LISP 脚本）：
  ```lisp
  (command "_netload" "D:\\BaiduSyncdisk\\software\\y-furniture\\furniture\\bin\\Debug\\net47\\furniture.dll")
  (princ)
  ```

---

## 1. 三轴加工功能

### 主要逻辑

- 在功能区（Ribbon）新增“三轴加工”面板，包含“绘制图纸”命令按钮。
- 点击“绘制图纸”后，弹出常驻 Palette（停靠面板），面板上以按钮形式列出各种型号的子命令。
- 用户点击不同型号按钮，即可调用对应的绘图命令，自动绘制所选型号的图纸。
- Palette 支持后续扩展，可灵活添加更多型号及其绘图逻辑。

### 相关代码

- `Core/RibbonController.cs`：功能区与按钮注册。
- `Commands/DrawingsPaletteCommandHandler.cs`：Palette 命令处理。
- `UI/Palettes/DrawingsPaletteControl.cs`：Palette UI 与型号按钮的事件处理。
- `Features/DrawingUtils.cs`：主建模与绘图逻辑（如 `DrawTable306`、`DrawTable309`、`DrawDoorWithGroove` 方法及辅助函数）。
- `UI/Forms/Table309InputForm.cs`：309型餐桌的参数输入对话框。
- `UI/Forms/DoorInputForm.cs`：串带门板的参数输入对话框。

### 功能案例

#### 306型餐桌绘制要点
- 支持交互输入餐桌长度、宽度，输入框可用上下键切换。
- 自动绘制四角为四分之一圆弧的标准圆角矩形，bulge 精确，顺序正确。
- 四角各绘制独立四分之一圆弧，便于三轴加工。
- 四角自动排列两组同心圆（直径9.5/12），并通过 x/y 方向镜像，确保八组分布一致。
- y 方向居中三组同心圆，左右对称镜像，便于定位。
- 自动绘制 4 条水平方向直线，自动排列。
- 所有图元均自动排列、镜像，确保与加工图纸一致。

#### 309型餐桌绘制要点
- **参数化输入**：通过弹出的 `Table309InputForm` 对话框，用户可自定义餐桌的长度和宽度。
- **主体绘制**：
  - 在原点(0,0,0)绘制一个由用户输入的长宽决定的标准矩形。
  - 在矩形的四个角上，额外绘制独立的、半径为20的四分之一圆弧，矩形本身保持直角。
- **四角同心圆阵列**：
  - 预设六组同心圆（直径11.5/14）的基础坐标。
  - 如果餐桌长度大于2000，所有基础坐标的X值会增加50。
  - 将这六组同心圆作为左下角的基础图形，通过水平、垂直和中心对称镜像，将其复制到所有四个象限，形成总共24组同心圆。
- **中心附加图形**：
  - 同样根据餐桌长度是否大于2000应用条件性X坐标偏移。
  - 在餐桌一侧绘制一组附加图形，包括：
    - 一个 56x755 的矩形。
    - 一条跨越中心线的垂直线。
    - 两组同心圆（直径9.5/12）并向上阵列5行（总计10组）。
  - 将这组附加图形整体沿餐桌的垂直中线（Y轴）进行左右对称镜像。
- **水平线阵列**：
  - 根据餐桌长度条件计算X坐标的偏移。
  - 在图纸内部绘制4条水平直线，Y坐标从 `宽度/5` 开始，以 `宽度/5` 为间距向上阵列。

#### 串带门板绘制要点
- **参数化输入**：通过弹出的 `DoorInputForm` 对话框，用户可自定义门板长度、宽度、串带边距、串带下边距和串带长度。对话框支持使用“上/下箭头”键切换焦点。
- **主体绘制**：根据输入参数，首先在原点(0,0,0)绘制门板的矩形外框。
- **串带阵列**：
  - 自动计算串带的排列数量和间距，以确保间距在 `[300, 500]` 的合理范围内。
  - 沿X轴方向，等距离排列多组“串带”（每组由一条直线和一条U型多段线构成）。
  - 对排列距离小于300mm的特殊情况做了处理，保证至少在两端绘制串带。
- **水平线排列**：
  - 在门板内部，沿Y轴方向均匀排列4条水平直线。
  - 直线的水平范围由串带边距和固定值（60mm）共同决定。

### 注意事项

- bulge 参数需精确，圆角顺序与 AutoCAD 多段线方向一致。
- 圆心、切点、镜像算法需严格按图纸逻辑，避免偏差。
- 所有参数均可交互输入，便于不同尺寸扩展。
- Palette UI 支持多型号扩展，便于后续维护。
- 可扩展尺寸标注、图层管理等功能。

---

## 2. 部件制作功能

### 主要逻辑

- **数据驱动建模**：本功能采用面向对象的设计思想。核心是 `DrawerBox` 数据类，它不仅存储了部件的几何参数（长、宽、高），还存储了业务数据（如名称、材质）。
- **命令执行流程**：
  1.  用户通过 Ribbon -> "家具部件" -> "部件制作" -> "抽屉框制作" 按钮触发 `_DrawBox` 命令。
  2.  命令从用户处获取参数。
  3.  程序创建一个 `DrawerBox` 对象实例来封装所有数据。
  4.  调用该实例的 `CreateEntity` 方法，在CAD中生成对应的 `Solid3d` 实体。
  5.  调用 `AttachDataToEntity` 方法，将 `DrawerBox` 对象中的所有数据作为**扩展实体数据 (XData)** 写入到新创建的 `Solid3d` 实体中。
- **数据持久化**：通过使用 XData，部件的所有属性都与图形实体绑定，并随 `.dwg` 文件一同保存。这为后续的编辑、统计和BOM表生成等高级功能奠定了基础。

### 相关代码

- `Core/RibbonController.cs`：功能区与按钮注册。
- `Commands/ComponentsPaletteCommandHandler.cs`：Palette 命令处理。
- `UI/Palettes/ComponentsPaletteControl.cs`：Palette UI 与“抽屉框制作”按钮的事件处理。
- `Features/DrawingUtils.cs`：包含 `_DrawBox` 命令的实现，负责协调用户输入和调用 `DrawerBox` 类。

### 功能案例

#### 抽屉框制作要点
- **参数输入**：通过命令行交互输入长度、高度和板厚。
- **面向对象创建**：程序会创建一个 `DrawerBox` 对象来管理所有数据和操作。
- **实体生成**：根据 `DrawerBox` 对象的属性，通过面域拉伸生成三维实体，并旋转至正确位置。
- **数据附加**：部件的**名称、材质、长度、高度、板厚**等信息，会作为扩展实体数据（XData）自动附加到生成的三维实体上，并随图纸保存。
- **自动清理**：建模后自动删除辅助的二维多段线。

### 注意事项

- **核心数据模型**：本功能依赖于 `Features/DrawerBox.cs` 中定义的数据模型。

---

## 3. 家具属性功能

### 主要逻辑

- 在功能区（Ribbon）新增“家具属性”面板，包含“属性编辑”命令按钮。
- 点击“属性编辑”后，弹出常驻 Palette（停靠面板），面板上包含用于读取和编辑实体附加数据的子命令。
- 此功能模块化，便于后续扩展更多属性管理相关的功能。

### 相关代码

- `Core/RibbonController.cs`：功能区与按钮注册。
- `Commands/PropertyPaletteCommandHandler.cs`：Palette 命令处理。
- `UI/Palettes/PropertyPaletteControl.cs`：Palette UI 与“读取/编辑属性”按钮的事件处理。
- `UI/Forms/PropertyEditForm.cs`：用于编辑属性的弹窗。
- `Features/DrawerBox.cs`：**核心数据模型**。定义了所有部件属性，并实现了基于JSON的数据序列化与反序列化逻辑。

### 功能案例

#### 属性编辑与查看
- **读取属性**：在“家具属性”面板中，点击“读取部件属性”按钮，然后选择任一之前创建的部件，即可查看其内部存储的所有数据。
- **附加/编辑属性**：点击“附加/编辑属性”按钮，然后选择一个CAD实体：
  - 如果该实体**已有**属性数据，则会弹出一个包含其现有数据的表单供您修改。
  - 如果该实体**没有**属性数据（例如一个普通的CAD长方体），程序会根据其外包围盒尺寸自动生成一套初始数据，并弹出表单供您填写。
  - 在表单中点击“确定”后，所有属性（部件名称、零件名称、材质、下料余量等）都会被保存或更新到该实体上。

### 注意事项

- **数据结构**：`DrawerBox.cs` 是所有数据驱动功能的核心。它定义了部件的所有属性，并提供 `ReadDataFromEntity` 方法用于从CAD实体中解析数据。
- **数据存储**：所有附加数据都以**固定顺序的字段**形式，存储在实体的扩展数据（XData）中，应用程序名为 `YZ_FURNITURE_DATA`。
- **写入逻辑**：为确保操作的绝对可靠性，数据写入逻辑被直接实现在需要它的命令处理器中（如 `DrawingUtils.cs` 和 `PropertyPaletteControl.cs`），而不是通过 `DrawerBox` 的方法调用。
- **扩展性**：此方案稳定可靠。未来增加新字段时，需要：1) 在`DrawerBox`类中添加属性；2) 在`ReadDataFromEntity`中增加解析代码；3) 在所有写入点（如`_DrawBox`命令）同步更新写入的字段。
- **UI交互**：所有参数输入对话框建议支持“上下箭头”键在输入框之间切换焦点，提升输入效率。

---

如需补充其它重要事项，可继续补充“注意事项”或“建议”部分，保持结构清晰、重点突出。这样便于新成员快速理解项目结构和开发要点。
